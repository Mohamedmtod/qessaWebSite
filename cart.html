<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QESSA - Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</title>
    <!-- Base styles -->
    <link rel="stylesheet" href="css/base.css?v=1.1">
    <link rel="stylesheet" href="css/components.css?v=1.1">
    <link rel="stylesheet" href="css/pages.css?v=1.1">
    <link
        href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700&family=Outfit:wght@300;400;600&display=swap"
        rel="stylesheet">
</head>

<body>
    <!-- Header/Nav injected by js/render.js -->
    <header class="x-head"></header>

    <main class="page-container" style="padding-top: 120px;">
        <div class="cart-container">
            <div class="cart-header">
                <h2>Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ğŸ›’</h2>
            </div>

            <div id="cart-content" class="cart-content">
                <div class="spinner"></div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="x-footer">
        <p>&copy; 2025 QESSA PERFUMES. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
    </footer>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Scripts -->
    <!-- Essential scripts for data and rendering -->
    <script type="module" src="js/firebase-config.js?v=1.1"></script>
    <script type="module" src="js/dataSource.js?v=1.1"></script>
    <script src="js/render.js?v=1.1"></script>

    <!-- Cart Logic -->
    <script src="js/cart.js?v=1.1"></script>

    <!-- Page Specific Logic -->
    <script type="module">
        // Wait for modules & DOM
        async function initCartPage() {
            renderNav();

            // Need products logic: use window.DataSource to ensure we have products
            // Cart relies on products being available to show details.
            try {
                // Ensure PRODUCTS are loaded
                if (!window.PRODUCTS || window.PRODUCTS.length === 0) {
                    if (window.DataSource) {
                        const allProducts = await window.DataSource.getProducts('all');
                        window.PRODUCTS = allProducts;
                    }
                }

                renderCartItems();

            } catch (e) {
                console.error(e);
                document.getElementById('cart-content').innerHTML = '<p class="text-center" style="color:red">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>';
            }
        }

        function renderCartItems() {
            const container = document.getElementById('cart-content');
            const cart = window.Cart.getCart();
            const products = window.PRODUCTS || []; // Should be populated now

            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="text-center" style="padding: 40px; color: var(--text-dim);">
                        <p style="font-size: 1.2rem; margin-bottom: 20px;">Ø³Ù„ØªÙƒ ÙØ§Ø¶ÙŠØ© ğŸ›’</p>
                        <a href="index.html" class="x-btn-secondary">ØªØµÙØ­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
                    </div>
                `;
                return;
            }

            // Map cart items to product details
            // Helper to find product
            const getProduct = (id) => products.find(p => p.id === id);

            let itemsHTML = '<div class="cart-items">';
            let total = 0;
            let hasFormattedTotal = true;

            cart.forEach(item => {
                const product = getProduct(item.id);
                if (!product) {
                    // Product deleted or not found
                    // Show item with ID or skip? Better to show ID so user can remove it
                    itemsHTML += renderCartItemHTML({ name: `Ù…Ù†ØªØ¬ Ù…Ø­Ø°ÙˆÙ (${item.id})`, id: item.id, images: [] }, item.qty, null);
                    hasFormattedTotal = false;
                    return;
                }

                // Pricing logic (approximate for display)
                let price = 0;
                let priceStr = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                // Try to grab a "Normal" price for display context
                if (product.pricing) {
                    if (product.pricing.fixedNormal) price = product.pricing.fixedNormal;
                    else if (product.pricing.midNormal) price = product.pricing.midNormal;
                    else if (product.pricing.normal) price = product.pricing.normal;
                    else if (product.pricing.normalAfter) price = product.pricing.normalAfter;
                }

                if (price) {
                    total += price * item.qty;
                    priceStr = `${price} ${SETTINGS.currency}`;
                } else {
                    hasFormattedTotal = false;
                }

                itemsHTML += renderCartItemHTML(product, item.qty, priceStr);
            });

            itemsHTML += '</div>'; // close cart-items

            // Summary
            itemsHTML += `
                <div class="cart-summary">
                    ${hasFormattedTotal && total > 0 ? `
                    <div class="cart-total-row">
                        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹:</span>
                        <span>${total} ${SETTINGS.currency}</span>
                    </div>
                    ` : ''}
                    
                    <div class="cart-actions">
                        <button class="btn-clear" onclick="window.Cart.clearCart(); location.reload();">ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©</button>
                        <button class="btn-whatsapp" onclick="window.Cart.exportToWhatsApp()">
                            Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = itemsHTML;

            // Attach Events
            container.querySelectorAll('.btn-inc').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.closest('.qty-btn').dataset.id;
                    window.Cart.updateQty(id, 1);
                    renderCartItems(); // Re-render to update totals
                });
            });
            container.querySelectorAll('.btn-dec').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.closest('.qty-btn').dataset.id;
                    window.Cart.updateQty(id, -1);
                    renderCartItems();
                });
            });
            container.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.closest('.remove-btn').dataset.id;
                    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) {
                        window.Cart.removeFromCart(id);
                        renderCartItems();
                    }
                });
            });
        }

        function renderCartItemHTML(product, qty, priceStr) {
            const img = (product.images && product.images.length) ? product.images[0] : 'https://placehold.co/100';
            return `
                <div class="cart-item">
                    <img src="${img}" alt="${product.name}">
                    <div class="cart-item-details">
                        <h4>${product.name}</h4>
                        <p>${priceStr || ''}</p>
                    </div>
                    <div class="cart-controls">
                        <button class="qty-btn btn-dec" data-id="${product.id}">-</button>
                        <span class="qty-val">${qty}</span>
                        <button class="qty-btn btn-inc" data-id="${product.id}">+</button>
                        <button class="remove-btn" data-id="${product.id}" title="Ø­Ø°Ù">Ã—</button>
                    </div>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', initCartPage);
    </script>
</body>

</html>